<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spotify</title>
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <link href="stylesheets/app.css" rel="stylesheet">
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>Accede a Spotify</h1>
        <a href="/login" class="btn btn-primary">Iniciar Sesión</a>
      </div>
      <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
        <button class="btn btn-primary" id="obtain-new-token">Obtain new token using the refresh token</button>
        <div class="contenedor-link"><a class="btn btn-primary" id="busca-artistas">Las canciones más poulares en Chile</a></div>
      </div>
      <div id="busqueda-artistas">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <div class="row">
                <div class="col-md-6 col-md-offset-3">
                  <h1>Las 50 canciones más populares en Chile <i class="fa fa-music" aria-hidden="true"></i></h1>
                  <form>
                    <fieldset>
                      <legend>Busca un artista</legend>
                      <input class="form-control" value="" placeholder="Escribe el nombre del artista...">
                      <button class="btn btn-primary">Buscar</button>
                    </fieldset>

                    <fieldset>
                      <legend>Selecciona el artista</legend>
                      <select class="form-control" id="artists"></select>
                    </fieldset>

                    <fieldset>
                      <legend>Elige un album</legend>
                      <select class="form-control" id="albums"></select>
                    </fieldset>

                  </form>
                  <button id="topCincuenta">50 Artistas</button>

                  <ul></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Ingresaste como {{display_name}}</h1>
      <div class="media">
        <div class="pull-left">
          <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <dl class="dl-horizontal">
            <dt>Nombre</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Imagen de Perfil</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>País</dt><dd>{{country}}</dd>
          </dl>
        </div>
      </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>Información de Autentificación</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}></dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        } else {
        if (access_token) {
          oauthPlaceholder.innerHTML = oauthTemplate({
            access_token: access_token,
            refresh_token: refresh_token
          });

          $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                $('#login').hide();
                $('#loggedin').show();
              }
          });

          /********************
          ********************
          ********************
          ********************/

          var $esconderOauth = $('#busca-artistas');
          var $button = $("form button");
          var $artistsSelect = $("#artists");
          var $albumsSelect = $("#albums");
          var $tracksContainer = $("ul");
          var $topCincuenta = $("#topCincuenta");

          /* @begin event button-click to get artists from spotify */

          $esconderOauth.on("click", function(e) {

            e.preventDefault();
            $('#loggedin').hide();
            $('#busqueda-artistas').show();

          });


          $button.on("click", function(e) {

            e.preventDefault();

            var $input = $("form input");
            var sArtistToFind = $input.val();
            var sGetArtistsUrl = "https://api.spotify.com/v1/search?type=track&market=US&query=" + sArtistToFind

            $.ajax({
              url: sGetArtistsUrl,
              dataType: "json",
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function( oDataReceived ) {

                var aArtists = oDataReceived.artists.items;
                var oCurrentArtist;
                var sOptions = "<option>Please select your artist...</option>";

                $.each( aArtists, function( index, value ) {
                  oCurrentArtist = value;
                  sOptions += "<option value='" + oCurrentArtist.id + "'>" + oCurrentArtist.name + "</option>"
                });

                $artistsSelect.html(sOptions);

              }
            })
          })
          /* @end event button-click to get artists from spotify  */


          /* @begin event get albums when artist is selected */
          $artistsSelect.on("change", function(e) {

            var $optionSelected = $(this).find("option:selected");
            var sIdArtist = $optionSelected.val();

            var sGetAlbumsUrl = "https://api.spotify.com/v1/artists/" + sIdArtist + "/albums";

            $.ajax({
              url: sGetAlbumsUrl,
              dataType: "json",
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function( oDataReceived ) {

                var aAlbums = oDataReceived.items;
                var oCurrentAlbum;
                var sOptions = "<option>Please select your album...</option>";

                $.each( aAlbums, function( index, value ) {
                  oCurrentAlbum = value;
                  sOptions += "<option value='" + oCurrentAlbum.id + "'>" + oCurrentAlbum.name + "</option>"
                })
                $albumsSelect.html(sOptions);
              }

            });

          });
          /* @end event get albums when artist is selected */


          /* @begin event get tracks when album is selected */
          $albumsSelect.on("change", function(e) {

            var $optionSelected = $(this).find("option:selected");
            var sIdAlbum = $optionSelected.val();

            var sGetTracksUrl = "https://api.spotify.com/v1/albums/" + sIdAlbum + "/tracks";

            $.ajax({
              url: sGetTracksUrl,
              dataType: "json",
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function( oDataReceived ) {
                var aTracks = oDataReceived.items;
                var oCurrentTrack;
                var sItems = "";

                $.each( aTracks, function( index, value ) {
                  oCurrentTrack = value;
                  console.log (oCurrentTrack);
                  sItems += "<li><a target='_blank' href='" + oCurrentTrack.preview_url+ "'>"+ oCurrentTrack.name + "</a></li>"
                });

                $tracksContainer.html(sItems)
              }
            });

          });

          $topCincuenta.on("change", function(e) {
            var mejoresCincuenta = "https://api.spotify.com/v1/users/spotifycharts/playlists/37i9dQZEVXbJs8e2vk15a8/tracks";

            $.ajax({
              url: mejoresCincuenta;
              dataType: "json",
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function( oDataReceived ) {
                var aTracks = oDataReceived.items;
                var oCurrentTrack;
                var sItems = "";

                $.each( aTracks, function (index,value)) {
                  console.log (oCurrentTrack);
                  sItems += "<li><a target='_blank' href='" + '#' + "'>"+ oCurrentTrack.name + "</a></li>"
                }
              }
            });
          });



          /* @end event get tracks when album is selected */

          /********************
          ********************
          ********************
          ********************/

        } else {

            $('#login').show();
            $('#loggedin').hide();
        }

        document.getElementById('obtain-new-token').addEventListener('click', function() {
          $.ajax({
            url: '/refresh_token',
            data: {
              'refresh_token': refresh_token
            }
          }).done(function(data) {
            access_token = data.access_token;
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });
          });
        }, false);




        }
      })();


    </script>
  </body>
</html>

